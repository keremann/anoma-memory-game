<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Anoma Memory Game</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
:root{ --mint:#6ee7b7; --ink:#032520; --text:#e6eef8; --bg1:#1e0b3a; --bg2:#0c1a3d; }
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--text); font-family:"Press Start 2P",system-ui,Arial;
  background:linear-gradient(135deg,var(--bg1),var(--bg2)); background-size:200% 200%;
  animation:bgShift 18s ease-in-out infinite;
  display:flex; flex-direction:column; align-items:center; gap:16px;
}
@keyframes bgShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

header{
  width:min(1200px,94%); margin-top:16px; display:flex; align-items:center; justify-content:space-between;
  background:rgba(8,12,24,.55); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 14px;
  backdrop-filter:blur(6px)
}
.brand{display:flex; align-items:center; gap:12px}
.brand img{width:48px;height:48px;border-radius:10px}
h1{font-size:18px; margin:0; letter-spacing:1px}

.hud{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
.badge{ background:var(--mint); color:var(--ink); padding:6px 10px; border-radius:10px; font-size:12px; box-shadow:0 0 16px rgba(110,231,183,.35) }
.pill{padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); font-size:10px; background:rgba(255,255,255,.06)}
button{
  border:none; cursor:pointer; font-family:inherit; font-weight:900; letter-spacing:.5px;
  background:var(--mint); color:var(--ink); padding:10px 14px; border-radius:10px; font-size:12px;
  box-shadow:0 10px 26px rgba(110,231,183,.25)
}

main{ width:min(1200px,94%); display:flex; flex-direction:column; gap:12px; align-items:center; }

/* grid fits viewport automatically */
.grid{
  --cols:4; --card:100px;
  display:grid; grid-template-columns:repeat(var(--cols), var(--card));
  gap:12px; width:100%; justify-content:center;
}
.card{ width:var(--card); height:calc(var(--card)*1.3333); position:relative; border-radius:12px; perspective:1000px; outline:none }
.cardInner{ position:absolute; inset:0; border-radius:12px; transform-style:preserve-3d; transition:transform .5s ease }
.card.flipped .cardInner{ transform:rotateY(180deg) }
.face{ position:absolute; inset:0; backface-visibility:hidden; border-radius:12px; display:flex; align-items:center; justify-content:center; overflow:hidden; border:2px solid rgba(255,255,255,.08) }

/* FRONT (role/term or image) */
.front{
  transform:rotateY(180deg);
  background:
    radial-gradient(120px circle at 50% 35%, rgba(110,231,183,.22), transparent),
    linear-gradient(180deg, #0b1220, #060b14);
}
.role{ display:flex; flex-direction:column; align-items:center; gap:8px; text-align:center; padding:6px }
.role .emoji{font-size:calc(var(--card)*0.28); filter:drop-shadow(0 0 8px rgba(255,255,255,.25))}
.role .name{
  font-size:clamp(9px, calc(var(--card)*0.18), 14px);
  line-height:1.15;
  padding:0 6px;
  word-break:break-word;
  hyphens:auto;
  text-wrap:balance;
}
.front img.faceImg{width:100%; height:100%; object-fit:cover;}

/* BACK (animated intent) */
.back{
  position:relative;
  background:#05131b url('04XToCah_400x400.jpg') center/58% no-repeat;
  box-shadow: inset 0 0 0 2px rgba(110,231,183,.35), 0 0 28px rgba(110,231,183,.18);
}
.back::before{
  content:""; position:absolute; inset:-20%;
  background:
    radial-gradient(closest-side, rgba(110,231,183,.20), transparent 60%),
    conic-gradient(from 0deg, rgba(255,255,255,.06), transparent 35%, rgba(255,255,255,.06) 70%, transparent 100%);
  filter: blur(10px);
  animation:intentPulse 4.5s ease-in-out infinite, intentSpin 16s linear infinite;
  mix-blend-mode:screen; pointer-events:none;
}
@keyframes intentPulse{0%,100%{opacity:.45; transform:scale(1)}50%{opacity:.8; transform:scale(1.06)}}
@keyframes intentSpin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

/* match halo + ring */
.card.matched .front{
  box-shadow:0 0 24px rgba(110,231,183,.7), 0 0 60px rgba(110,231,183,.35), inset 0 0 0 2px rgba(110,231,183,.9);
}
.ring{ position:absolute; border-radius:50%; border:2px solid rgba(110,231,183,.85); left:50%; top:50%; width:10px; height:10px; transform:translate(-50%,-50%); animation:ring .6s ease-out forwards; pointer-events:none }
@keyframes ring{0%{opacity:1; transform:translate(-50%,-50%) scale(.6)}100%{opacity:0; transform:translate(-50%,-50%) scale(3)}}

/* overlay */
#overlay{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:10; background:rgba(0,0,0,.65)}
.box{ background:#0f1a24; border:1px solid var(--mint); border-radius:14px; padding:22px; width:min(580px,94%); text-align:center; box-shadow:0 14px 40px rgba(0,0,0,.45) }
.box h2{margin:0 0 12px; font-size:16px}
.box p{font-size:12px; line-height:1.7}

/* role-up banner (only on milestones) */
.roleUp{ position:fixed; inset:0; pointer-events:none; display:flex; align-items:center; justify-content:center; z-index:12; font-size:20px; color:#fff; text-shadow:0 0 18px rgba(255,255,255,.9) }
.roleUp .badge{ background:rgba(0,0,0,.35); border:2px solid rgba(255,255,255,.85); border-radius:14px; padding:14px 18px; animation: rolePop .7s ease, fadeOut 1.6s ease 1.1s forwards }
@keyframes rolePop{0%{transform:scale(.7); opacity:.2}100%{transform:scale(1); opacity:1}}
@keyframes fadeOut{to{opacity:0; transform:scale(.98)}}

/* confetti + flash */
.confetti-container{position:fixed; inset:0; pointer-events:none; z-index:11; overflow:hidden}
.confetti{position:absolute; width:8px; height:12px; opacity:.95; animation:fall linear forwards}
@keyframes fall{0%{transform:translateY(-20vh) rotate(0)}100%{transform:translateY(110vh) rotate(720deg)}}
.flash{position:fixed; inset:0; background:#fff; opacity:0; pointer-events:none; z-index:12}
.flashWhite{animation:fw .45s ease} @keyframes fw{0%{opacity:.75}100%{opacity:0}}

/* signature */
.signature{ position:fixed; bottom:12px; right:14px; font-size:11px; color:var(--mint); text-shadow:0 0 6px rgba(110,231,183,.7); opacity:.9; z-index:15 }

/* rules box (bottom-right) */
.rules{
  position:fixed; right:12px; bottom:48px; z-index:14;
  background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.18); border-radius:12px;
  padding:10px 12px; width:min(360px, 88vw); font-size:10px; line-height:1.6;
  backdrop-filter: blur(6px);
}
.rules h4{ margin:0 0 6px; font-size:11px; color:#cdebe3; letter-spacing:.5px }
.rules p{ margin:4px 0 }
.rules .note{ margin-top:6px; opacity:.85; font-size:9.5px; color:#d7fff3 }
</style>
</head>
<body>

<header>
  <div class="brand">
    <img src="04XToCah_400x400.jpg" alt="Anoma"/>
    <h1>Anoma Memory Game</h1>
  </div>
  <div class="hud">
    <div id="moves" class="badge">Moves: 0</div>
    <div id="timer" class="badge">Time: 00:30</div>
    <div id="roleB"  class="badge">Role: Initiate</div>
    <div id="levelPill" class="pill">Level 1 / 3</div>
    <button id="resetBtn">Restart</button>
  </div>
</header>

<main>
  <div class="pill">Match all pairs before time runs out. Quizzes may appear for bonus time!</div>
  <div id="grid" class="grid" aria-label="Memory grid" role="grid"></div>
</main>

<!-- overlay -->
<div id="overlay">
  <div class="box" id="overlayBox">
    <h2 id="ovTitle">Great!</h2>
    <p id="ovText">You matched all cards.</p>
    <div id="ovChoices" style="margin:10px 0"></div>
    <button id="ovBtn">Next</button>
  </div>
</div>

<div id="flash" class="flash"></div>
<div class="signature">X : Keremannn</div>

<!-- Rules box -->
<div class="rules">
  <h4>Rules</h4>
  <p>Level 1 ‚Üí <b>30s</b>, quiz correct <b>+1s</b>, wrong match <b>no penalty</b></p>
  <p>Level 2 ‚Üí <b>45s</b>, quiz correct <b>+1s</b>, wrong match <b>‚àí0.1s</b></p>
  <p>Level 3 ‚Üí <b>60s</b>, quiz correct <b>+1s</b>, wrong match <b>‚àí0.25s</b></p>
  <p class="note">‚è∏Ô∏è Timer does not decrease during quizzes.</p>
</div>

<script>
/* ---------- Assets ---------- */
const LOGO = '04XToCah_400x400.jpg';
const MANAGERS = [
  'S4eHJ1uT_400x400.jpg',
  'jx4icx3D_400x400.jpg',
  'Fdegt4rn_400x400 (2).jpg',
  'Ekran g√∂r√ºnt√ºs√º 2025-08-29 002743.png'
];

/* ---------- Data ---------- */
const ROLES = [
  {name:'Initiate',      color:'#8a63d2', emoji:'üî∞'},
  {name:'Apprentice',    color:'#1d4ed8', emoji:'üìò'},
  {name:'Seeker',        color:'#10b981', emoji:'üß≠'},
  {name:'Acolyte',       color:'#f59e0b', emoji:'üí†'},
  {name:'Master',        color:'#ef4444', emoji:'üó°Ô∏è'},
  {name:'Grand Master',  color:'#ef4444', emoji:'üíé'},
  {name:'Intent Master', color:'#22d3ee', emoji:'üß†'},
  {name:'Wizard',        color:'#f472b6', emoji:'üßô‚Äç‚ôÇÔ∏è'}
];
const TERMS = [
  {name:'Intent', color:'#6ee7b7', emoji:'üéØ'},
  {name:'Privacy', color:'#60a5fa', emoji:'üï∂Ô∏è'},
  {name:'Solver', color:'#f59e0b', emoji:'üß©'},
  {name:'Atomic Settle', color:'#34d399', emoji:'‚ö°'},
  {name:'MASP', color:'#22d3ee', emoji:'üõ°Ô∏è'},
  {name:'Counterparty', color:'#f472b6', emoji:'üîó'},
];

const ROLE_ORDER      = ['Initiate','Apprentice','Seeker','Acolyte','Master','Grand Master','Intent Master','Wizard'];
const ROLE_THRESHOLDS = [0,3,6,10,15,21,26,30]; // total matches milestones

/* pairs: 7 / 10 / 13 ‚Äî s√ºreler g√ºncellendi (30 / 45 / 60) */
const LEVELS = [
  {pairs:7,  time:30, quizBonus:1, wrongPenalty:0},     // L1
  {pairs:10, time:45, quizBonus:1, wrongPenalty:0.1},   // L2
  {pairs:13, time:60, quizBonus:1, wrongPenalty:0.25}   // L3
];
const QUIZ_FREQ = 0.10; // 10%

/* ---------- Quiz Pool (answers shuffled) ---------- */
const QUIZ_POOL = [
  {q:'Anoma is best described as‚Ä¶', a:['a distributed OS for intent-centric apps','a single-chain L2','an NFT marketplace']},
  {q:'In Anoma, an intent is‚Ä¶', a:['a desired outcome with constraints','a raw transaction','a mempool lane']},
  {q:'Who composes intents into executable transactions?', a:['solvers','validators only','end-users manually']},
  {q:'Anoma aims to unify‚Ä¶', a:['underlying blockchains','only EVM chains','only private chains']},
  {q:'Counterparty discovery is‚Ä¶', a:['intent-centric','orderbook-only','centralized']},
  {q:'MASP stands for‚Ä¶', a:['Multi-Asset Shielded Pool','Multi-Account Settlement Pool','Managed Asset Sharing Protocol']},
  {q:'Privacy in Anoma is‚Ä¶', a:['programmable by design','not supported','only via mixers']},
  {q:'Shielded transfers rely on‚Ä¶', a:['zero-knowledge proofs','trusted third parties','multi-sig only']},
  {q:'Intents let users express‚Ä¶', a:['preferences & constraints','node hardware','gas token prices']},
  {q:'Top role after Grand Master?', a:['Wizard','Seeker','Acolyte']},
  {q:'Solvers mainly‚Ä¶', a:['satisfy intents','mint blocks','store private keys']},
  {q:'Multi-chain atomic‚Ä¶', a:['settlement','snapshots','RPC only']},
];

/* ---------- DOM ---------- */
const gridEl   = document.getElementById('grid');
const movesEl  = document.getElementById('moves');
const timerEl  = document.getElementById('timer');
const roleEl   = document.getElementById('roleB');
const levelPill= document.getElementById('levelPill');
const overlay  = document.getElementById('overlay');
const ovTitle  = document.getElementById('ovTitle');
const ovText   = document.getElementById('ovText');
const ovBtn    = document.getElementById('ovBtn');
const ovChoices= document.getElementById('ovChoices');
const flashEl  = document.getElementById('flash');
document.getElementById('resetBtn').addEventListener('click',()=> startGame()); // restart ‚Üí Initiate

/* ---------- State ---------- */
let currentLevel = 0, deck = [], firstPick=null, lock=false;
let moves = 0, timeLeft = 30, timerId = null;
let totalMatches = 0, currentRoleIndex = 0;

/* ---------- Audio ---------- */
const audioCtx = (typeof AudioContext !== 'undefined') ? new AudioContext() : (typeof webkitAudioContext!=='undefined' ? new webkitAudioContext() : null);
function tone(f=440, d=0.08, t='sine', g=0.06){ if(!audioCtx) return; const o=audioCtx.createOscillator(),x=audioCtx.createGain(); o.type=t;o.frequency.value=f;x.gain.value=g;o.connect(x);x.connect(audioCtx.destination);o.start(); setTimeout(()=>{x.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+d);o.stop(audioCtx.currentTime+d)}, d*800);}
const sFlip = ()=> tone(700,.05,'triangle',.05);
const sMatch= ()=> { tone(660,.09,'sine',.07); setTimeout(()=>tone(990,.09,'sine',.07),90); };
const sWrong= ()=> { tone(180,.12,'sawtooth',.05); };
const sWin  = ()=> { [523,659,784].forEach((f,i)=> setTimeout(()=>tone(f,.12,'sine',.08), i*120)); };

/* ---------- Utils ---------- */
const pad=n=>String(n).padStart(2,'0');
const fmt=s=>`${pad(Math.floor(s/60))}:${pad(Math.max(0,Math.ceil(s))%60).toString().padStart(2,'0')}`;
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]] } return a; }
function confetti(){ const old=document.querySelector('.confetti-container'); if(old) old.remove(); const c=document.createElement('div'); c.className='confetti-container'; document.body.appendChild(c); const colors=['#6ee7b7','#22d3ee','#f472b6','#f59e0b','#60a5fa','#34d399','#f43f5e']; for(let i=0;i<140;i++){ const s=document.createElement('span'); s.className='confetti'; const sz=6+Math.random()*6; s.style.width=`${sz}px`; s.style.height=`${(sz*1.4).toFixed(1)}px`; s.style.left=Math.random()*100+'vw'; s.style.top=(-10-Math.random()*20)+'vh'; s.style.background=colors[(Math.random()*colors.length)|0]; s.style.animationDuration=(1.6+Math.random()*1.2).toFixed(2)+'s'; s.style.animationDelay=(Math.random()*0.2).toFixed(2)+'s'; s.style.borderRadius=Math.random()<0.4?'2px':'50%'; c.appendChild(s);} setTimeout(()=>c.remove(),2200);}
function flash(){ flashEl.className='flash flashWhite'; setTimeout(()=> flashEl.className='flash', 450); }
function banner(txt){ const d=document.createElement('div'); d.className='roleUp'; d.innerHTML=`<div class="badge">ROLE UP ‚Üí ${txt}</div>`; document.body.appendChild(d); setTimeout(()=>d.remove(),2200); }
function setBGByRole(name){ const map={ 'Initiate':['#231447','#0f1b35'], 'Apprentice':['#123a8f','#0a1e54'], 'Seeker':['#0b3d33','#092628'], 'Acolyte':['#5a2d00','#241a07'], 'Master':['#3a0d12','#12080b'], 'Grand Master':['#4c0f14','#17090b'], 'Intent Master':['#0a3a46','#071f2a'], 'Wizard':['#391036','#141022'] }; const [b1,b2]=map[name]||['#1e0b3a','#0c1a3d']; document.documentElement.style.setProperty('--bg1',b1); document.documentElement.style.setProperty('--bg2',b2); }

/* ---------- Deck ---------- */
function makeItemFromRole(r){ return {type:'role', key:r.name, name:r.name, color:r.color, emoji:r.emoji}; }
function makeItemFromTerm(t){ return {type:'role', key:t.name, name:t.name, color:t.color, emoji:t.emoji}; }
function makeItemFromImage(src){ return {type:'img', key:src, src:encodeURI(src)}; }
function planForLevel(levelIndex){
  const plans = [ {r:3,m:2,t:2}, {r:4,m:3,t:3}, {r:5,m:4,t:4} ]; // sums: 7/10/13
  return plans[levelIndex];
}
function buildDeck(levelIndex){
  const {r,m,t} = planForLevel(levelIndex);
  const roleItems = shuffle(ROLES.filter(x=>x.name!=='Wizard')).slice(0, r).map(makeItemFromRole);
  const termItems = shuffle([...TERMS]).slice(0, t).map(makeItemFromTerm);
  const mgrItems  = shuffle(MANAGERS).slice(0, m).map(makeItemFromImage);
  let base = [...roleItems, ...termItems, ...mgrItems];      // length == pairs
  return shuffle(base.concat(base)).map((c,i)=> ({...c, id:i, matched:false}));
}

/* ---------- Rendering ---------- */
function computeCardSize(total){
  // columns near sqrt for compact grid
  const cols = Math.max(4, Math.ceil(Math.sqrt(total)));
  const rows = Math.ceil(total / cols);

  const headerH = document.querySelector('header').offsetHeight || 100;
  const verticalMargin = 170;
  const availH = Math.max(360, window.innerHeight - headerH - verticalMargin);
  const sizeByH = Math.floor((availH / rows) * 0.75);
  const availW = Math.floor(window.innerWidth * 0.92);
  const gapTotal = (cols - 1) * 12;
  const sizeByW = Math.floor((availW - gapTotal) / cols);
  const card = Math.max(70, Math.min(sizeByH, sizeByW, 220));

  gridEl.style.setProperty('--cols', cols);
  gridEl.style.setProperty('--card', card + 'px');
}
function renderGrid(){
  computeCardSize(deck.length);
  gridEl.innerHTML = '';
  for(const c of deck){
    const el = document.createElement('button');
    el.className = 'card'; el.setAttribute('data-id', c.id);
    let frontHTML = '';
    if (c.type==='img'){
      frontHTML = `<img class="faceImg" src="${c.src}" alt=""/>`;
    } else {
      frontHTML = `<div class="role"><div class="emoji">${c.emoji}</div><div class="name" style="color:${c.color}">${c.name}</div></div>`;
    }
    el.innerHTML = `
      <div class="cardInner">
        <div class="face back"></div>
        <div class="face front">${frontHTML}</div>
      </div>`;
    el.addEventListener('click', ()=> flip(c.id));
    el.addEventListener('keydown', navKey);
    gridEl.appendChild(el);
  }
  gridEl.querySelector('.card')?.focus();
}

/* ---------- HUD / Timer ---------- */
function currentLevelConfig(){ return LEVELS[currentLevel]; }
function updateRoleHUD(){ const role=ROLE_ORDER[currentRoleIndex]; roleEl.textContent=`Role: ${role}`; setBGByRole(role); }
function resetHUD(){
  moves=0; movesEl.textContent='Moves: 0';
  timeLeft = currentLevelConfig().time;
  timerEl.textContent='Time: '+fmt(timeLeft);
  levelPill.textContent = `Level ${currentLevel+1} / ${LEVELS.length}`;
}
function startTimer(){
  clearInterval(timerId);
  timerId = setInterval(()=>{
    timeLeft -= 1;
    if(timeLeft < 0) timeLeft = 0;
    timerEl.textContent = 'Time: '+fmt(timeLeft);
    if(timeLeft<=0){ onTimeUp(); }
  }, 1000);
}
function stopTimer(){ clearInterval(timerId); }
function pauseTimer(){ stopTimer(); }
function resumeTimer(){ startTimer(); }
function onTimeUp(){
  stopTimer();
  overlay.style.display='flex';
  ovTitle.textContent='Time‚Äôs Up!';
  ovText.textContent ='Out of time. Restarting from Level 1 (Initiate)‚Ä¶';
  ovChoices.innerHTML='';
  ovBtn.textContent='Restart Now';
  ovBtn.onclick=()=>{ overlay.style.display='none'; startGame(); }; // FULL reset to Initiate
  setTimeout(()=>{ if(overlay.style.display==='flex') startGame(); }, 1500); // auto reset ‚Üí Initiate
}

/* ---------- Game Flow ---------- */
function startGame(){ // full reset to Initiate
  currentLevel=0; totalMatches=0; currentRoleIndex=0;
  updateRoleHUD(); loadLevel();
}
function loadLevel(){
  deck = buildDeck(currentLevel);
  firstPick=null; lock=false;
  resetHUD(); renderGrid(); startTimer();
}
function nextLevel(){
  if(currentLevel < LEVELS.length-1){ currentLevel++; loadLevel(); }
  else { currentRoleIndex = ROLE_ORDER.length-1; updateRoleHUD();
    overlay.style.display='flex'; ovTitle.textContent='You are a Wizard!'; ovText.innerHTML=`All levels cleared. Final moves <b>${moves}</b>`; ovChoices.innerHTML=''; ovBtn.textContent='Play Again'; ovBtn.onclick=()=>{ overlay.style.display='none'; startGame(); }; }
}

function checkMilestone(){
  if (currentRoleIndex < ROLE_ORDER.length-1 && totalMatches >= ROLE_THRESHOLDS[currentRoleIndex+1]){
    currentRoleIndex++; banner(ROLE_ORDER[currentRoleIndex]); updateRoleHUD();
  }
}

/* ---------- Quiz ---------- */
function makeQuiz(){
  const base = QUIZ_POOL[(Math.random()*QUIZ_POOL.length)|0];
  const opts = [...base.a];
  const correctText = opts[0];
  const shuffled = shuffle(opts);
  const correctIndex = shuffled.indexOf(correctText);
  return { q: base.q, options: shuffled, correct: correctIndex };
}
function askQuiz(onClose){
  const b = makeQuiz();
  overlay.style.display='flex';
  ovTitle.textContent = 'Quick Quiz!';
  ovText.textContent  = b.q;
  ovChoices.innerHTML = '';
  b.options.forEach((opt, i)=>{
    const btn = document.createElement('button');
    btn.textContent = opt; btn.style.margin='6px';
    btn.onclick = ()=>{
      if(i===b.correct){
        const bonus = currentLevelConfig().quizBonus; // L1:+1, L2:+1, L3:+1  (top-level kurala uygun)
        ovText.innerHTML = `Correct! +${bonus} sec`;
        addTime(bonus);
      } else {
        ovText.innerHTML = 'Not quite! (no time penalty)';
      }
      setTimeout(()=>{ overlay.style.display='none'; onClose(); }, 420);
    };
    ovChoices.appendChild(btn);
  });
  ovBtn.textContent='Skip';
  ovBtn.onclick = ()=>{ overlay.style.display='none'; onClose(); };
}

/* ---------- Flip / Match ---------- */
function addTime(sec){
  timeLeft = Math.max(0, timeLeft + sec);
  timerEl.textContent = 'Time: '+fmt(timeLeft);
}
function applyWrongPenalty(){
  const p = currentLevelConfig().wrongPenalty; // 0 / 0.1 / 0.25
  if(p>0){
    timeLeft = Math.max(0, timeLeft - p);
    timerEl.textContent = 'Time: '+fmt(timeLeft);
  }
}
function flip(id){
  if(lock) return;
  const card = deck.find(c=>c.id===id);
  if(!card || card.matched) return;
  const el = gridEl.querySelector(`.card[data-id="${id}"]`);
  if(el.classList.contains('flipped')) return;
  el.classList.add('flipped'); sFlip();

  // %10 quiz ‚Äî ilk kartta; quiz sƒ±rasƒ±nda zaman durur
  if(!firstPick && Math.random() < QUIZ_FREQ){
    lock = true; pauseTimer();
    setTimeout(()=> askQuiz(()=>{ lock=false; resumeTimer(); }), 200);
  }

  if(!firstPick){ firstPick = card; return; }

  moves++; movesEl.textContent='Moves: '+moves; lock = true;
  const second = card;

  if(firstPick.key === second.key && firstPick.id !== second.id){
    setTimeout(()=>{
      firstPick.matched = second.matched = true;
      [firstPick,second].forEach(c=>{
        const e = gridEl.querySelector(`.card[data-id="${c.id}"] .front`);
        if(e){ const r=document.createElement('div'); r.className='ring'; e.appendChild(r); setTimeout(()=>r.remove(),650); }
      });
      sMatch();

      totalMatches++; checkMilestone();

      setTimeout(()=>{ lock=false; firstPick=null; checkWin(); }, 220);
    }, 160);
  } else {
    setTimeout(()=>{
      gridEl.querySelector(`.card[data-id="${firstPick.id}"]`)?.classList.remove('flipped');
      gridEl.querySelector(`.card[data-id="${second.id}"]`)?.classList.remove('flipped');
      sWrong(); applyWrongPenalty(); lock=false; firstPick=null;
    }, 520);
  }
}

function checkWin(){
  if(deck.every(c=>c.matched)){
    stopTimer(); confetti(); flash(); sWin();
    overlay.style.display='flex';
    ovTitle.textContent='Level Cleared!';
    ovText.innerHTML=`Time left <b>${fmt(timeLeft)}</b> ‚Ä¢ Moves <b>${moves}</b>`;
    ovChoices.innerHTML='';
    ovBtn.textContent='Next Level';
    ovBtn.onclick=()=>{ overlay.style.display='none'; nextLevel(); };
  }
}

/* ---------- Keyboard ---------- */
function navKey(e){
  const keys=['arrowup','arrowdown','arrowleft','arrowright',' ','enter'];
  if(!keys.includes(e.key.toLowerCase())) return; e.preventDefault();
  const cards=[...gridEl.querySelectorAll('.card')]; const idx=cards.indexOf(document.activeElement);
  const cols=parseInt(getComputedStyle(gridEl).getPropertyValue('--cols'))||4;
  if(e.key.toLowerCase()==='arrowleft' && idx>0) cards[idx-1].focus();
  if(e.key.toLowerCase()==='arrowright' && idx<cards.length-1) cards[idx+1].focus();
  if(e.key.toLowerCase()==='arrowup' && idx-cols>=0) cards[idx-cols].focus();
  if(e.key.toLowerCase()==='arrowdown' && idx+cols<cards.length) cards[idx+cols].focus();
  if(e.key===' '||e.key.toLowerCase()==='enter'){ const id=+document.activeElement.getAttribute('data-id'); if(!Number.isNaN(id)) flip(id); }
}

/* ---------- Init ---------- */
function updateRoleHUD(){ const role=ROLE_ORDER[currentRoleIndex]; roleEl.textContent=`Role: ${role}`; setBGByRole(role); }
function startGame(){ // full reset ‚Üí Initiate
  currentLevel=0; totalMatches=0; currentRoleIndex=0;
  updateRoleHUD(); loadLevel();
}
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) stopTimer(); else resumeTimer(); });
document.body.addEventListener('click', ()=>{ if(audioCtx && audioCtx.state==='suspended') audioCtx.resume(); }, {once:true});
window.addEventListener('resize', renderGrid);
startGame();
</script>
</body>
</html>
